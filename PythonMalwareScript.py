######################################################################
# This was for a project on Signature Based Malware Detection. I was #
# given a compromised system and had to write a script to scan the   #
# entire system and identify malware based on its signature.         #
######################################################################

import os
import hashlib
import time
import re
import subprocess

# sudo /bin/python3 /home/blueteam/scripts/PythonMalwareScript.py

scan_directories = ["/"]

excluded_directories = ["/proc", "/var", "/run", "/snap", "/usr", "/dev", "/sys", "/blackteam", "/home/blueteam/.cache/JetBrains/", "/home/blueteam/.vscode-server"]

print("Scanning for malware in directories:", scan_directories)

def scan_and_remove_malware():
    malicious_files_found = 0
    pattern = re.compile(r'^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}\.sh$')
    for scan_directory in scan_directories:
        for root, _, files in os.walk(scan_directory):
            if any(root.startswith(excluded_dir) for excluded_dir in excluded_directories):
                continue

            for file in files:
                file_path = os.path.join(root, file)
                if pattern.match(file):
                    malicious_files_found += 1
                    print("Malicious file found: " + file_path)
                    os.system('cp ' + file_path + ' /home/blueteam/malware/' + file + '.txt')
                    os.remove(file_path)

    return malicious_files_found

malicious_files_found = scan_and_remove_malware()

print("Scan complete. " + str(malicious_files_found) + " files removed.")
print(" ")

os.system('date > /home/blueteam/scripts/cron.txt')
os.system('mkdir /var/www/html')
print(" ")

os.system('cp /home/blueteam/WebpageBackup.txt /var/www/html/index.php')

output = subprocess.check_output("ps -fA | grep python | grep http", shell=True, universal_newlines=True)

# Check if there are any matching processes
if "python3 -m http.server 80" in output:
    subprocess.run("ps -fA | grep python | grep http | awk '{print $2}' | xargs -I {} sudo kill {}", shell=True)
    print("Processes killed.")
else:
    print("No malware processes found.")

os.system('systemctl restart apache2')
os.system('systemctl start apache2')

print(" ")
os.system('curl -I http://localhost')


print("End of Script")